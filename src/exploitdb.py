"""
ExploitDB Module
Fungsi: Integrasi dengan Exploit-DB untuk mencari dan download eksploit berdasarkan CVE.
Isi: Class ExploitDB dengan method search_exploit(cve) yang scrape atau query API Exploit-DB, return list eksploit yang cocok.
"""

import requests
from bs4 import BeautifulSoup
from utils import Logger
import re

class ExploitDB:
    def __init__(self, logger):
        # Fungsi: Inisialisasi ExploitDB client
        # Isi: Setup session, logger
        self.logger = logger
        self.session = requests.Session()
        self.base_url = "https://www.exploit-db.com"
    
    def search_exploit(self, cve):
        # Fungsi: Cari eksploit berdasarkan CVE
        # Isi: Query search page, parse HTML, extract eksploit links dan deskripsi
        self.logger.info(f"Mencari eksploit untuk {cve} di Exploit-DB...")
        search_url = f"{self.base_url}/search?cve={cve}"
        try:
            response = self.session.get(search_url, timeout=10)
            response.raise_for_status()
            soup = BeautifulSoup(response.text, 'html.parser')
            exploits = []
            # Parse table eksploit
            table = soup.find('table', {'id': 'exploits-table'})
            if table:
                rows = table.find_all('tr')[1:]  # Skip header
                for row in rows:
                    cols = row.find_all('td')
                    if len(cols) >= 5:
                        exploit_id = cols[0].text.strip()
                        title = cols[2].text.strip()
                        platform = cols[3].text.strip()
                        link = self.base_url + cols[1].find('a')['href'] if cols[1].find('a') else ""
                        exploits.append({
                            'id': exploit_id,
                            'title': title,
                            'platform': platform,
                            'link': link,
                            'cve': cve
                        })
            return exploits
        except Exception as e:
            self.logger.error(f"Error searching Exploit-DB: {e}")
            return []
    
    def download_exploit(self, exploit_link):
        # Fungsi: Download kode eksploit
        # Isi: Fetch halaman eksploit, extract kode dari <code> tag
        try:
            response = self.session.get(exploit_link, timeout=10)
            response.raise_for_status()
            soup = BeautifulSoup(response.text, 'html.parser')
            code_block = soup.find('code')
            if code_block:
                return code_block.text.strip()
            else:
                self.logger.warning("Tidak ada kode eksploit di halaman.")
                return None
        except Exception as e:
            self.logger.error(f"Error downloading exploit: {e}")
            return None