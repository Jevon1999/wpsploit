"""
Advanced Exploit Parser & CVE Mapper
Fungsi: Parser advanced untuk eksploit, map CVE, dan match WordPress-specific.
Isi: Class ExploitParser dengan method parse_exploit_code, map_cve, match_wordpress.
"""

import re
from utils import Logger

class ExploitParser:
    def __init__(self, logger):
        # Fungsi: Inisialisasi parser
        # Isi: Setup regex patterns untuk CVE, WordPress
        self.logger = logger
        self.cve_pattern = re.compile(r'CVE-\d{4}-\d+', re.IGNORECASE)
        self.wordpress_pattern = re.compile(r'wordpress|wp-', re.IGNORECASE)
    
    def parse_exploit_code(self, code):
        # Fungsi: Parse kode eksploit untuk extract info
        # Isi: Cari CVE, platform, dll dari komentar atau kode
        info = {
            'cves': self.cve_pattern.findall(code),
            'is_wordpress': bool(self.wordpress_pattern.search(code)),
            'language': self.detect_language(code),
            'description': self.extract_description(code)
        }
        return info
    
    def detect_language(self, code):
        # Fungsi: Deteksi bahasa eksploit
        # Isi: Cek ekstensi atau keyword
        if 'import' in code and 'def ' in code:
            return 'python'
        elif '<?php' in code:
            return 'php'
        elif '#!/bin/bash' in code:
            return 'bash'
        return 'unknown'
    
    def extract_description(self, code):
        # Fungsi: Extract deskripsi dari komentar
        # Isi: Cari komentar awal
        lines = code.split('\n')[:10]
        desc = []
        for line in lines:
            if line.strip().startswith('#') or line.strip().startswith('//'):
                desc.append(line.strip()[1:].strip())
            elif desc:
                break
        return ' '.join(desc)
    
    def map_cve_to_exploits(self, exploits):
        # Fungsi: Map CVE ke list exploits
        # Isi: Buat dict CVE -> list exploits
        cve_map = {}
        for exploit in exploits:
            cves = self.cve_pattern.findall(exploit.get('cve', ''))
            for cve in cves:
                cve = cve.upper()
                if cve not in cve_map:
                    cve_map[cve] = []
                cve_map[cve].append(exploit)
        return cve_map
    
    def match_wordpress_exploits(self, exploits):
        # Fungsi: Filter exploits WordPress-specific
        # Isi: Return hanya yang match WordPress
        return [e for e in exploits if self.wordpress_pattern.search(e.get('title', '') + e.get('platform', ''))]