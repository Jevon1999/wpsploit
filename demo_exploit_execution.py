#!/usr/bin/env python3
"""
Example exploit execution demo
Test exploit execution engine tanpa actual vulnerability
"""

from pathlib import Path
import sys

sys.path.insert(0, str(Path(__file__).parent / "src"))

from utils import Logger
from exploiter import Exploiter
from settings import Settings

# Demo Python exploit code
DEMO_PYTHON_EXPLOIT = """#!/usr/bin/env python3
# Demo exploit for testing
import sys

print("[*] Starting demo exploit...")
print(f"[*] Target URL: {sys.argv[1] if len(sys.argv) > 1 else 'NO_URL'}")

# Simulate exploit behavior
print("[+] Checking target...")
print("[+] Exploiting vulnerability...")
print("[+] Success! Demo exploit completed")

sys.exit(0)
"""

# Demo Bash exploit
DEMO_BASH_EXPLOIT = """#!/bin/bash
# Demo bash exploit
echo "[*] Starting bash exploit..."
echo "[*] Target: $TARGET_URL"
echo "[+] Demo bash exploit completed"
exit 0
"""

def test_python_exploit():
    """Test Python exploit execution"""
    print("\n" + "="*60)
    print("TEST: Python Exploit Execution")
    print("="*60)
    
    logger = Logger()
    settings = Settings(logger)
    exploiter = Exploiter(logger, settings)
    
    # Mock vulnerability data
    vuln = {
        'template-id': 'test-cve-2024-demo',
        'info': {
            'name': 'Demo Vulnerability',
            'tags': ['cve-2024-demo']
        }
    }
    
    parsed_info = {
        'language': 'python',
        'cves': ['CVE-2024-DEMO'],
        'is_wordpress': True,
        'description': 'Demo exploit'
    }
    
    print("\n[1] Executing demo Python exploit...")
    result = exploiter.run_exploit_code(
        DEMO_PYTHON_EXPLOIT,
        "https://demo-target.com",
        vuln,
        parsed_info
    )
    
    print(f"\nStatus: {result['status']}")
    print(f"Success: {result['success']}")
    print(f"Language: {result['language']}")
    print(f"\nOutput:\n{result['output']}")
    
    return result['success']

def test_bash_exploit():
    """Test Bash exploit execution"""
    print("\n" + "="*60)
    print("TEST: Bash Exploit Execution")
    print("="*60)
    
    logger = Logger()
    settings = Settings(logger)
    exploiter = Exploiter(logger, settings)
    
    vuln = {
        'template-id': 'test-bash-demo',
        'info': {
            'name': 'Demo Bash Vulnerability',
            'tags': ['demo']
        }
    }
    
    parsed_info = {
        'language': 'bash',
        'cves': ['CVE-2024-BASH'],
        'is_wordpress': True,
        'description': 'Demo bash exploit'
    }
    
    print("\n[1] Executing demo Bash exploit...")
    result = exploiter.run_exploit_code(
        DEMO_BASH_EXPLOIT,
        "https://demo-target.com",
        vuln,
        parsed_info
    )
    
    print(f"\nStatus: {result['status']}")
    print(f"Success: {result['success']}")
    print(f"Language: {result['language']}")
    print(f"\nOutput:\n{result['output']}")
    
    return result['success']

def main():
    print("\n" + "="*60)
    print("EXPLOIT EXECUTION ENGINE - DEMO")
    print("="*60)
    print("\nThis demo tests the exploit execution engine")
    print("with safe demo exploits (no actual attacks)")
    
    tests = [
        ("Python Exploit", test_python_exploit),
        ("Bash Exploit", test_bash_exploit),
    ]
    
    results = []
    for name, test_func in tests:
        try:
            result = test_func()
            results.append((name, result))
        except Exception as e:
            print(f"\n✗ {name} FAILED: {e}")
            import traceback
            traceback.print_exc()
            results.append((name, False))
    
    # Summary
    print("\n" + "="*60)
    print("DEMO SUMMARY")
    print("="*60)
    
    for name, result in results:
        status = "✓ PASSED" if result else "✗ FAILED"
        print(f"{status}: {name}")
    
    passed = sum(1 for _, r in results if r)
    print(f"\nTotal: {passed}/{len(results)} tests passed")
    
    print("\n" + "="*60)
    print("✓ Exploit execution engine is working!")
    print("="*60)

if __name__ == "__main__":
    main()
